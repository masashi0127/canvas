<html>
<head>
<title>Insert title here</title>
<style type="text/css">
* {
	margin: 0;
	padding: 0;
}
</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript">
window.addEventListener('load', eventWindowLoaded, false);
function eventWindowLoaded() {
	canvasApp();
}

function canvasApp() {
	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');
	var textbutton = document.getElementById('textbutton');
	var w = document.body.clientWidth;
	var h = document.body.clientHeight - 50;
	var arrObjChara = new Array();
	var me = object(Me);
	window.selectedChara;
	window.resizeChara;
	canvas.width = w;
	canvas.height = h;
	textbutton.addEventListener('click', division, false);
	canvas.addEventListener('mousedown', charaSelectd, false);
	canvas.addEventListener('mousemove', charaDraging, false);
	canvas.addEventListener('mouseup', charaDetached, false);

	box();

	function division(e) {
		var textchara = $("input#textfield").val();
		var arrTextChara = textchara.split('');
		for( var i = 0; i < arrTextChara.length; i++) {
			var objChara = object(Chara);
			objChara.chara = arrTextChara[i];
			box();
			objChara.setParam();
			arrObjChara.push(objChara);
		}
		draw();
	}

	function draw() {
		if(typeof arrObjChara !== 'undefined' && arrObjChara.length !== 0) {
			for( var i = 0; i < arrObjChara.length; i++) {
				var objChara = arrObjChara[i];
				objChara.meDraw();
			}
		}
	}

	function box() {
		ctx.fillStyle = '#DDDDDD';
		ctx.fillRect(0, 0, w, h);
	}

	function charaSelectd(e) {
		me.down = true;
		me.up = false;
		var cx = e.clientX;
		var cy = e.clientY;
		box();
		if (typeof selectedChara !== 'undefined') {
			var coordinates = coordinate(selectedChara);
			if (coordinates.px <= cx && coordinates.nx >= cx && coordinates.py <= cy && coordinates.ny >= cy) {
				selectedChara.selected(cx, cy);
				selectedChara.meDraw();
			} else if (coordinates.tlpx <= cx && coordinates.tlnx >= cx && coordinates.tlpy <= cy && coordinates.tlny >= cy) {
				selectedChara.setSelectedParam('tl', cx, cy);
			} else if (coordinates.blpx <= cx && coordinates.blnx >= cx && coordinates.blpy <= cy && coordinates.blny >= cy) {
				selectedChara.setSelectedParam('bl', cx, cy);
			} else if (coordinates.brpx <= cx && coordinates.brnx >= cx && coordinates.brpy <= cy && coordinates.brny >= cy) {
				selectedChara.setSelectedParam('br', cx, cy);
			} else if(coordinates.trpx <= cx && coordinates.trnx >= cx && coordinates.trpy <= cy && coordinates.trny >= cy) {
				selectedChara.setSelectedParam('tr', cx, cy);
			} else if(selectedChara.rotateCheck(cx, cy)) {
				selectedChara.setSelectedParam('rt', cx, cy);
			} else {
				arrObjChara.unshift(selectedChara);
				delete selectedChara;
			}
		}
		for (var i = 0; i < arrObjChara.length; i++) {
			var objChara = arrObjChara[i];
			var px = objChara.x;
			var nx = objChara.x + objChara.measure.width;
			var py = objChara.y;
			var ny = objChara.y + objChara.font_size;
			if (typeof selectedChara === 'undefined' && px <= cx && nx >= cx && py <= cy && ny >= cy) {
				selectedChara = objChara;
				selectedChara.selected(cx, cy);
				var del_idx = i;
			}
			objChara.meDraw();
		}
		if(typeof del_idx !== 'undefined') arrObjChara.splice(del_idx, 1);
	}

	function charaDraging(e) {
		if(typeof selectedChara !== 'undefined' && me.down === true && me.up === false) {
			box();
			var cx = e.clientX;
			var cy = e.clientY;
			if (typeof selectedChara !== 'undefined') {
				if (selectedChara.resizing_flg) {
					selectedChara.resized(cx, cy);
					selectedChara.resizeDraw();
					selectedChara.selected(cx, cy);
					selectedChara.translateChange();
					ctx.translate(-1 * selectedChara.trans_x, -1 * selectedChara.trans_y);
				} else if (selectedChara.rotate_flg) {
					selectedChara.rotateDraw();
					selectedChara.selected(cx, cy);
				} else {
					selectedChara.moved(cx, cy);
					selectedChara.meDraw();
					selectedChara.selected(cx, cy);
				}
				for(var i = 0; i < arrObjChara.length; i++) {
					var objChara = arrObjChara[i];
					objChara.meDraw();
				}
			} else {
				for (var i = 0; i < arrObjChara.length; i++) {
					var objChara = arrObjChara[i];
					var coordinates = coordinate(objChara);
					if (coordinates.px <= cx && coordinates.nx >= cx && coordinates.py <= cy && coordinates.ny >= cy) {
						selectedChara = objChara;
						arrObjChara.splice(i, 1);
					}
					objChara.meDraw();
				}
			}
		}
	}

	function coordinate(objChara) {
		var coordinates = {
			px: objChara.x,
			nx: objChara.x + objChara.measure.width,
			py: objChara.y,
			ny: objChara.y + objChara.font_size,
			tlpx: objChara.top_left_x,
			tlpy: objChara.top_left_y,
			tlnx: objChara.top_left_x + objChara.point_side_length,
			tlny: objChara.top_left_y + objChara.point_side_length,
			blpx: objChara.bottom_left_x,
			blpy: objChara.bottom_left_y,
			blnx: objChara.bottom_left_x + objChara.point_side_length,
			blny: objChara.bottom_left_y + objChara.point_side_length,
			brpx: objChara.bottom_right_x,
			brpy: objChara.bottom_right_y,
			brnx: objChara.bottom_right_x + objChara.point_side_length,
			brny: objChara.bottom_right_y + objChara.point_side_length,
			trpx: objChara.top_right_x,
			trpy: objChara.top_right_y,
			trnx: objChara.top_right_x + objChara.point_side_length,
			trny: objChara.top_right_y + objChara.point_side_length,
		};

		return coordinates;
	}

	function charaDetached(e) {
		var cx = e.clientX;
		var cy = e.clientY;
		box();
		if (typeof selectedChara !== 'undefined') {
			if (selectedChara.resizing_flg) {
				selectedChara.resizing_flg = false;
				selectedChara.resizeEnd();
			} else if (selectedChara.rotate_flg) {
				selectedChara.rotate_flg = false;
				selectedChara.resizeEnd();
			}
			selectedChara.selected();
			selectedChara.meDraw();
		}
		for (var i = 0; i < arrObjChara.length; i++) {
			var objChara = arrObjChara[i];
			objChara.meDraw();
		}
		me.down = false;
		me.up = true;
	}

	function drag(e) {
		alert('ok');
	}

	var Chara = {
		chara: '',
		x:0,
		y:0,
		pre_x: 0,
		pre_y: 0,
		trans_x: 0,
		trans_y: 0,
		top_left_x: 0,
		top_left_y: 0,
		bottom_left_x: 0,
		bottom_left_y: 0,
		bottom_right_x: 0,
		bottom_right_y: 0,
		top_right_x: 0,
		top_right_y: 0,
		rotate_x: 0,
		rotate_y: 0,
		rotate_radius: 5,
		font_size: 30,
		start_font_size: 30,
		point_side_length: 10,
		font_type: 'px monospace',
		measure: 0,
		start_measure: 0,
		resizing_flg: false,
		rotate_flg: false,
		select_type: '',
		r: 0,
		g: 0,
		b: 0,
		a: 0,

		setParam: function() {
			this.x = Math.floor(Math.random() * w);
			this.y = Math.floor(Math.random() * h);
			this.r = Math.floor(Math.random() * 256);
			this.g = Math.floor(Math.random() * 256);
			this.b = Math.floor(Math.random() * 256);
			this.a = (1 + Math.floor(Math.random() * 10)) / 10;
		},

		meDraw: function() {
			ctx.fillStyle = 'rgba(' + this.r + ', ' + this.g + ', ' + this.b + ', ' + this.a + ')';
			ctx.font = this.font_size + this.font_type;
			ctx.textBaseline = 'top';
			this.measure = ctx.measureText(this.chara);
			this.start_measure = this.measure;
			ctx.fillText(this.chara, this.x, this.y);
		},

		selected: function(cx, cy) {
			this.topLeftPoint();
			this.bottomLeftPoint();
			this.topRightPoint();
			this.bottomRightPoint();
			this.rotatePoint();
			this.pre_x = cx;
			this.pre_y = cy;
		},

		topLeftPoint: function() {
			ctx.strokeStyle = 'rgba(255, 0, 0, 1)';
			var x = this.x - this.point_side_length;
			var y = this.y - this.point_side_length;
			this.top_left_x = x;
			this.top_left_y = y;
			ctx.strokeRect(x, y, this.point_side_length, this.point_side_length);
		},

		bottomLeftPoint: function() {
			ctx.strokeStyle = 'rgba(255, 0, 0, 1)';
			var cx = this.x;
			var cy = this.y + this.font_size;
			var x = cx - this.point_side_length;
			var y = cy;
			this.bottom_left_x = x;
			this.bottom_left_y = y;
			ctx.strokeRect(x, y, this.point_side_length, this.point_side_length);
		},

		bottomRightPoint: function() {
			ctx.strokeStyle = 'rgba(255, 0, 0, 1)';
			var cx = this.x + this.measure.width;
			var cy = this.y + this.font_size;
			var x = cx;
			var y = cy;
			this.bottom_right_x = x;
			this.bottom_right_y = y;
			ctx.strokeRect(x, y, this.point_side_length, this.point_side_length);
		},

		topRightPoint: function() {
			ctx.strokeStyle = 'rgba(255, 0, 0, 1)';
			var cx = this.x + this.measure.width;
			var cy = this.y;
			var x = cx;
			var y = cy - this.point_side_length;
			this.top_right_x = x;
			this.top_right_y = y;
			ctx.strokeRect(x, y, this.point_side_length, this.point_side_length);
		},

		rotatePoint: function() {
			this.rotate_x = this.top_right_x + this.point_side_length + this.rotate_radius / 2 + 1;
			this.rotate_y = this.top_right_y - this.rotate_radius / 2 - 1;
			ctx.beginPath();
			ctx.fillStyle = 'rgba(255, 0, 0, 1)';
			ctx.lineWidth = 0;
			ctx.arc(this.rotate_x, this.rotate_y, this.rotate_radius, 0, Math.PI * 2, true);
			ctx.fill();
		},

		rotateCheck: function(cx, cy) {
			var x = this.rotate_x - cx;
			var y = this.rotate_y - cy;
			if(Math.sqrt(x * x + y * y) <= this.rotate_radius) return true;
			return false;
		},

		setSelectedParam: function(select_type, cx, cy) {
			this.select_type = select_type;
			if(select_type !== 'rt') {
				this.resizing_flg = true;
			} else {
				this.rotate_flg = true;
			}
			this.selected(cx, cy);
			this.meDraw();
		},

		moved: function(cx, cy) {
			this.x += cx - this.pre_x;
			this.y += cy - this.pre_y;
		},

		resized: function(cx, cy) {
			if(this.select_type === 'tl' || this.select_type === 'bl') {
				var parsent =  (this.x - cx + this.start_measure.width) / this.measure.width;
			} else {
				var parsent =  (cx - this.x) / this.measure.width;
			}
			this.pre_font_size = this.font_size;
			this.font_size *= parsent;
			if(this.font_size < 1) this.font_size = 1;
		},

		resizeDraw: function() {
			ctx.fillStyle = 'rgba(' + this.r + ', ' + this.g + ', ' + this.b + ', ' + this.a + ')';
			ctx.font = this.font_size + this.font_type;
			ctx.textBaseline = 'top';
			this.measure = ctx.measureText(this.chara);
			this.translateChange();
			ctx.translate(this.trans_x, this.trans_y);
			ctx.fillText(this.chara, this.x, this.y);
		},

		rotateDraw: function() {

		},

		translateChange: function() {
			if (this.select_type === 'tl') {
				this.trans_x = this.start_measure.width - this.measure.width;
				this.trans_y = this.start_font_size - this.font_size;
			} else if (this.select_type === 'bl') {
				this.trans_x = this.start_measure.width - this.measure.width;
				this.trans_y = 0;
			} else if (this.select_type === 'br') {
				this.trans_x = 0;
				this.trans_y = 0;
			} else if (this.select_type === 'tr') {
				this.trans_x = 0;
				this.trans_y = this.start_font_size - this.font_size;
			}
		},

		resizeEnd: function() {
			this.x += this.trans_x;
			this.y += this.trans_y;
			this.trans_x = 0;
			this.trans_y = 0;
			this.start_font_size = this.font_size;
		}
	};

	var Me = {
		down: false,
		up: true
	};
}

function object(o) {
	var f = object.f, i, len, n, prop;
	f.prototype = o;
	n = new f;
	for (i=1, len=arguments.length; i<len; ++i)
	for (prop in arguments[i])
	n[prop] = arguments[i][prop];
	return n;
}
object.f = function(){};
</script>
</head>
<body>
	<canvas id="canvas"></canvas>
	<form>
		<input type="text" id="textfield">
		<input type="button" id="textbutton" value="SET">
	</form>
</body>
</html>